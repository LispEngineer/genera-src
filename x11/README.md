# x11

Files related to X11 and keyboards.

* `xquartz-87.lisp` - A keyboard for use with Xquartz that provides a sane
mapping for an 87-key keyboard, extremely similar to the default X keyboard.
* `xquartz-87-enh.lisp` - An improved keyboard with better mappings.

If you're using Xquartz, load those files
and then start your X-Windows Screen. The keyboard will be picked
up automatically and configured properly.

This was designed for Xquartz 2.7.0_beta10 running on
macOS 10.11.5 while using an 87-key Tenkeyless standard keyboard.

# `xquartz-default-xmodmap.txt`

```
$ xmodmap -pk | sed 's/^ *//' | grep -v '^[0-9]* *.$' >xquartz-default-xmodmap.txt
```

Note that there are two entries for the `Escape` keysym, one for key code `61`, the
other for `79`.

* `61` is generated by the regular `ESC` key on the keyboard
* `79` is generated by the `Num Lock` key on the Japanese Windows USB keyboard I have.

The entry for `79` can be cleared with `xmodmap -e "keycode 79 = "`.


# Notes

* `sys:*consoles*` contains a list of all consoles.

```
(#<X-SCREEN::X-CONSOLE ...> ...)
```    

Genera seems to read the xmodmap once when the screen is started, to get
all the keynums and keysyms. If you change the xmodmap, it doesn't seem to
pick up on that later.

* `(x-screen::default-x-screen)` returns the default X-Windows screen. It seems to be the current one, as it will return a different value for each X-Windows connection, e.g.:
  * `#<X-REAL-SCREEN X Screen INTERNET|192.168.1.106:0.0 0 (Genera on BERYLLIUM) 1004206265 exposed>`

You can get a display by opening it, but I don't see how to get the current one
out of Flavors yet.

* `(xlib:open-display "INTERNET|192.168.1.106")`
  * This will give an error: `Error: INTERNET|192.168.1.106 does not support X-WINDOW-SYSTEM service.`
  * Simply respond `s-A: Use protocol X-WINDOW-SYSTEM on medium TCP.`
* `(xlib:display-vendor-name \*)`
  * `"The X.Org Foundation"`

You can find out a lot of information with the various functions. Search for
`def-clx-class (display` in the `clx.lisp` file to see what all the parts of the
display structure are.

* `(xlib:display-vendor-name ...)`
* `(xlib:display-release-number ...)`
* `(xlib:display-host ...)`
* `(xlib:display-default-screen ...)`
* `(xlib:display-vendor ...)` - returns multiple values, `vendor-name` and `release-number`
* `(xlib::display-keysym-mapping ...)` - `nil`?
* `(xlib::display-modifier-mapping ...)` - `nil`?
* `(xlib::display-keysym-tanslation ...)` - `nil`?
* `(xlib:display-min-keycode ...)`
* `(xlib:display-max-keycode ...)`
* `(xlib:display-roots ...)`
* `(xlib:display-xdefaults ...)` - `nil`?

So the `keyboard-signature` seems to be a way for Genera to automatically figure
out which keyboard is in use at the destination X screen and set the mappings
appropriately! As it turns out, the Xquarts 2.7.10_beta2 on macOS 10.11.5 returns
these relevant data about its screen:

* `min-keycode`: 8 - which is mapped to the `keycode-offset` when creating a signature
* `vendor-name`: `The X.Org Foundation`
* `vendor-version`: 118030000

Indeed, I created a test keyboard signature starting with the below:

```lisp
(define-keyboard-signature :xquartz-87-tenkeyless
                           (:keycode-offset 8
                            :vendor-name "The X.Org Foundation"
                            :vendor-version 11803000)
```

When I started a new X screen (`Start X Screen INTERNET|192.168.1.106 :Reuse No`),
and immediately checked the maping (`Show X Keyboard Mapping`), it responded
as I would hope:

```
The keyboard layout type is :XQUARTZ-87-TENKEYLESS.
```

Now, the next matter turns to the `define-keyboard-mapping`
to try to set the key mapping reasonably usably.

```lisp
(define-keyboard-mapping :xquartz-87-tenkeyless ()
```

## Mapping Notes

The only function that reads `*keyboard-mappings*` is
`x-screen::layout-type-keyboard-mapping`, and that seems
to be used in only three locations:

* `x-screen::fill-keyboard-table-specific`
* `x-screen::layout-type-leds`
* `x-screen::x-console-describe-keyboard-mapping` - Handles `Show X Keyboard Mapping` display

The `fill-keyboard-table-specific` is of great interest, as it seems to translate
`code-keys` into the actual Symbolics key that Genera sees. Viz, from the function in `x-console.lisp`:

```lisp
           ;; key code specific key mappings have the highest priority
           ;; Next comes shift specific key mappings 
           ;; finally mappings based on the unshifted keysym
```  

This is in turn called by `fill-keyboard-table` which calls all the `fill-keyboard-table-*` methods:

```lisp
(defun-in-flavor (fill-keyboard-table x-console) (table layout-type)
  (clear-keyboard-table table)
  (fill-keyboard-table-general table layout-type)
  (fill-keyboard-table-specific table layout-type)
  (fill-keyboard-table-symbol table layout-type)
  (fill-keyboard-table-fixup table layout-type))
```

And `fill-keyboard-table` is itself called by `x-console-update-keyboard-mapping`.

This is hard to figure out, though, as I cannot seem to call these methods
manually since `cli::keyboard` seems to be unbound. However, it seems that
it is part of the `x-keyboard` flavor, from this:

```lisp
(defflavor x-keyboard
        ((last-shifts nil)
         (leds nil))
        (cli::keyboard)
  :initable-instance-variables
  :readable-instance-variables
  :writable-instance-variables)
```


## Mappings

Here's the mapping. Note that some characters don't show up correctly
because I don't have a conversion from Genera's character encoding to
UTF-8 (yet).

Also, note that the key codes shown below are off by 8, because the
`:keycode-offset` was set to 8 above. That means the actual X-Windows
keycodes are all 8 higher. The Mac keycodes are those lower (8 lower)
numbers.

The desired mapping of the bottom row is:

```
Genera:    Control   Super  Meta      SPACE    Meta    Control Symbol    Hyper
Mac:       Control   Option Command   SPACE    Command Option  Menu      Control
Keycode:   67        66     63        57       69      71      118       70
Keysym+    Control-L Alt_L  Meta_L    space    Alt_R   Meta_R  NoSymbol  Control_R
```
